// Data
let weather = {
  paris: {
    name: "Paris",
    temp: 19.7,
    humidity: 80
  },
  tokyo: {
    name: "Tokyo",
    temp: 17.3,
    humidity: 50
  },
  lisbon: {
    name: "Lisbon",
    temp: 30.2,
    humidity: 20
  },
  "san francisco": {
    name: "San Francisco",
    temp: 20.9,
    humidity: 100
  },
  moscow: {
    name: "Moscow",
    temp: -5,
    humidity: 20
  },
  spring: {
    name: "Spring",
    temp: 30.2,
    humidity: 50
  },
  almaty: {
    name: "Almaty",
    temp: 20.9,
    humidity: 100
  },
  izegem: {
    name: "Izegem",
    temp: -5,
    humidity: 20
  }
};

let favorites = {
  spring: {
    name: "Spring",
    data: {
      current: {
        clouds: 40,
        dew_point: 24.3,
        dt: 1595528324,
        feels_like: 37.57,
        humidity: 59,
        pressure: 1015,
        sunrise: 1595504110,
        sunset: 1595553632,
        temp: 33.41,
        uvi: 11.68,
        visibility: 10000,
        weather: [{
          description: "scattered clouds",
          icon: "03d",
          id: 802,
          main: "Clouds"
        }],
        wind_deg: 60,
        wind_speed: 2.6,
      },
      daily: [{
          clouds: 40,
          dew_point: 24.3,
          dt: 1595527200,
          feels_like: {
            day: 36.96,
            eve: 36.35,
            morn: 36.96,
            night: 31.7
          },
          humidity: 59,
          pressure: 1015,
          sunrise: 1595504110,
          sunset: 1595553632,
          temp: 33.41,
          uvi: 11.68,
          visibility: 10000,
          weather: [{
            description: "scattered clouds",
            icon: "03d",
            id: 802,
            main: "Clouds"
          }],
          wind_deg: 63,
          wind_speed: 3.48
        },
        {
          clouds: 40,
          dew_point: 24.3,
          dt: 1595527200,
          feels_like: {
            day: 36.96,
            eve: 36.35,
            morn: 36.96,
            night: 31.7
          },
          humidity: 59,
          pressure: 1015,
          sunrise: 1595504110,
          sunset: 1595553632,
          temp: 33.41,
          uvi: 11.68,
          visibility: 10000,
          weather: [{
            description: "scattered clouds",
            icon: "03d",
            id: 802,
            main: "Clouds"
          }],
          wind_deg: 63,
          wind_speed: 3.48
        },
        {
          clouds: 40,
          dew_point: 24.3,
          dt: 1595527200,
          feels_like: {
            day: 36.96,
            eve: 36.35,
            morn: 36.96,
            night: 31.7
          },
          humidity: 59,
          pressure: 1015,
          sunrise: 1595504110,
          sunset: 1595553632,
          temp: 33.41,
          uvi: 11.68,
          visibility: 10000,
          weather: [{
            description: "scattered clouds",
            icon: "03d",
            id: 802,
            main: "Clouds"
          }],
          wind_deg: 63,
          wind_speed: 3.48
        },
        {
          clouds: 40,
          dew_point: 24.3,
          dt: 1595527200,
          feels_like: {
            day: 36.96,
            eve: 36.35,
            morn: 36.96,
            night: 31.7
          },
          humidity: 59,
          pressure: 1015,
          sunrise: 1595504110,
          sunset: 1595553632,
          temp: 33.41,
          uvi: 11.68,
          visibility: 10000,
          weather: [{
            description: "scattered clouds",
            icon: "03d",
            id: 802,
            main: "Clouds"
          }],
          wind_deg: 63,
          wind_speed: 3.48
        },
        {
          clouds: 40,
          dew_point: 24.3,
          dt: 1595527200,
          feels_like: {
            day: 36.96,
            eve: 36.35,
            morn: 36.96,
            night: 31.7
          },
          humidity: 59,
          pressure: 1015,
          sunrise: 1595504110,
          sunset: 1595553632,
          temp: 33.41,
          uvi: 11.68,
          visibility: 10000,
          weather: [{
            description: "scattered clouds",
            icon: "03d",
            id: 802,
            main: "Clouds"
          }],
          wind_deg: 63,
          wind_speed: 3.48
        },
        {
          clouds: 40,
          dew_point: 24.3,
          dt: 1595527200,
          feels_like: {
            day: 36.96,
            eve: 36.35,
            morn: 36.96,
            night: 31.7
          },
          humidity: 59,
          pressure: 1015,
          sunrise: 1595504110,
          sunset: 1595553632,
          temp: 33.41,
          uvi: 11.68,
          visibility: 10000,
          weather: [{
            description: "scattered clouds",
            icon: "03d",
            id: 802,
            main: "Clouds"
          }],
          wind_deg: 63,
          wind_speed: 3.48
        },
        {
          clouds: 40,
          dew_point: 24.3,
          dt: 1595527200,
          feels_like: {
            day: 36.96,
            eve: 36.35,
            morn: 36.96,
            night: 31.7
          },
          humidity: 59,
          pressure: 1015,
          sunrise: 1595504110,
          sunset: 1595553632,
          temp: 33.41,
          uvi: 11.68,
          visibility: 10000,
          weather: [{
            description: "scattered clouds",
            icon: "03d",
            id: 802,
            main: "Clouds"
          }],
          wind_deg: 63,
          wind_speed: 3.48
        },
        {
          clouds: 40,
          dew_point: 24.3,
          dt: 1595527200,
          feels_like: {
            day: 36.96,
            eve: 36.35,
            morn: 36.96,
            night: 31.7
          },
          humidity: 59,
          pressure: 1015,
          sunrise: 1595504110,
          sunset: 1595553632,
          temp: 33.41,
          uvi: 11.68,
          visibility: 10000,
          weather: [{
            description: "scattered clouds",
            icon: "03d",
            id: 802,
            main: "Clouds"
          }],
          wind_deg: 63,
          wind_speed: 3.48
        }
      ],
      lat: 30.09,
      lon: -95.38,
      timezone: "America/Chicago",
      timezone_offset: -18000
    }
  },
  almaty: {
    name: "Almaty",
    data: {
      coord: {
        lon: -95.36,
        lat: 29.76
      },
      weather: [{
        id: 211,
        main: "Thunderstorm",
        description: "thunderstorm",
        icon: "11d",
        base: "stations"
      }],
      main: {
        temp: 29.24,
        feels_like: 33.43,
        temp_min: 26,
        temp_max: 32,
        pressure: 1015,
        humidity: 88
      },
      visibility: 10000,
      wind: {
        speed: 5.1,
        deg: 250,
        gust: 8.2
      },
      clouds: {
        all: 75
      },
      dt: 1595440017,
      sys: {
        type: 1,
        id: 4850,
        country: "US",
        sunrise: 1595417710,
        sunset: 1595467218
      },
      timezone: -18000,
      id: 4699066,
      name: "Almaty",
      cod: 200
    }
  },
  izegem: {
    name: "Izegem",
    data: {
      coord: {
        lon: -95.36,
        lat: 29.76
      },
      weather: [{
        id: 211,
        main: "Thunderstorm",
        description: "thunderstorm",
        icon: "11d",
        base: "stations"
      }],
      main: {
        temp: 29.24,
        feels_like: 33.43,
        temp_min: 26,
        temp_max: 32,
        pressure: 1015,
        humidity: 88
      },
      visibility: 10000,
      wind: {
        speed: 5.1,
        deg: 250,
        gust: 8.2
      },
      clouds: {
        all: 75
      },
      dt: 1595440017,
      sys: {
        type: 1,
        id: 4850,
        country: "US",
        sunrise: 1595417710,
        sunset: 1595467218
      },
      timezone: -18000,
      id: 4699066,
      name: "Almaty",
      cod: 200
    }
  }
};

let sentence = "";

let currentCity = {
  name: "Houston",
  data: {
    coord: {
      lon: -95.36,
      lat: 29.76
    },
    weather: [{
      id: 211,
      main: "Thunderstorm",
      description: "thunderstorm",
      icon: "11d",
      base: "stations"
    }],
    main: {
      temp: 29.24,
      feels_like: 33.43,
      temp_min: 26,
      temp_max: 32,
      pressure: 1015,
      humidity: 88
    },
    visibility: 10000,
    wind: {
      speed: 5.1,
      deg: 250,
      gust: 8.2
    },
    clouds: {
      all: 75
    },
    dt: 1595440017,
    sys: {
      type: 1,
      id: 4850,
      country: "US",
      sunrise: 1595417710,
      sunset: 1595467218
    },
    timezone: -18000,
    id: 4699066,
    name: "Houston",
    cod: 200
  }
};

const apiKey = "cce07da6a69974d4cbb12e9fb81759f5";

let apiUrl = null;

let lat = null;

let long = null;

let currentPosition = null;

let currentCityName = null;

let city = null;

const currentDate = new Date();

let currentDay = null;

const months = [
  "Januari",
  "Februari",
  "March",
  "April",
  "May",
  "June",
  "July",
  "August",
  "September",
  "October",
  "November",
  "December"
];

const days = [
  "Sunday",
  "Monday",
  "Tuesday",
  "Wednesday",
  "Thursday",
  "Friday",
  "Saturday"
];

// common
const handleCelsiusToFahrenheit = value => {
  const temp = (value * 9) / 5 + 32;
  return temp.toFixed(1);
};

const handleFahrenheitToCelsius = value => {
  const temp = ((value - 32) * 5) / 9;
  return temp.toFixed(1);
};

const handleDisplayContent = array => {
  array.forEach(element => {
    const item = document.querySelector(element.class);

    item.innerHTML = element.content;
  });
};

const checkStatus = response => {
  if (!response.ok) {
    throw Error(response.statusText);
  }
  return response;
};

const handleGetCurrentLocation = event => {
  navigator.geolocation.getCurrentPosition(handlePosition);
};

const handleDisplayCurrentWeatherLocation = () => {
  const elements = [{
      class: ".today__title--location",
      content: currentCity.name
    },
    {
      class: ".today__text--temperature",
      content: currentCity.data.current.temp
    },
    {
      class: ".today__text--humidity",
      content: currentCity.data.current.humidity
    },
    {
      class: ".today__text--cold",
      content: currentCity.data.daily[0].temp.min
    },
    {
      class: ".today__text--hot",
      content: currentCity.data.daily[0].temp.max
    },
    {
      class: ".today__text--wind",
      content: currentCity.data.current.wind_speed
    }
  ];

  handleDisplayContent(elements);
};

const handleDisplayHourlyWeatherLocation = () => {
  const list = document.querySelector("#today__temperatureList");
  list.innerHTML = "";
  let tempCurrentDay = currentDay;

  currentCity.data.hourly.map((item, i) => {
    const div = document.createElement("div");
    const timestamp = item.dt;

    const date = new Date(timestamp * 1000);

    div.innerHTML = `<dt class='today__title today__title--hide'>
        00:30
      </dt>

      <dd>
        <article>
          <h4 class='today__title today__title--nowrap today__title--center'>
            ${item.temp}&#176;
            <span>
              C
            </span>
          </h4>

          <i class='fas fa-sun'></i>

          <p class='today__text today__text--center'>
            ${date.getHours()}:${(date.getMinutes() < 10 ? "0" + date.getMinutes() : date.getMinutes())}
          </p>
        </article>
      </dd>`;

    div.classList.add("today__temperatureItem");

    list.appendChild(div);
  })
}

const handleDisplayDailyWeatherLocation = () => {
  const list = document.querySelector("#week__list");
  list.innerHTML = "";
  let tempCurrentDay = currentDay;

  currentCity.data.daily.map((item, i) => {
    if (i !== 0) {
      if (tempCurrentDay < 6) {
        tempCurrentDay = tempCurrentDay + 1;
      } else if (tempCurrentDay === 6) {
        tempCurrentDay = 0;
      }

      const div = document.createElement("div");
      div.innerHTML = `<div class='card shadow p-3 mb-5 bg-white rounded'>
        <div class='cardbody'>
          <dt class='today__title today__title--hide'>
            Saturday
          </dt>

          <dd class='week__content'>
            <article>
              <h4 class='today__title today__title--center'>
                ${item.temp.day}&#176;
                <span>
                  C
                </span>
              </h4>

              <i class='fas fa-sun'></i>
              
              <p class='today__text today__text--center'>
                <small>
                  ${days[tempCurrentDay]}
                </small>
              </p>
            </article>
          </dd>
        </div>
      </div>`;

      div.classList.add("col");
      div.classList.add("col-12");
      div.classList.add("col-sm-6");
      div.classList.add("week__item");

      list.appendChild(div);
    }
  })
}

// Date
const handleChangeDate = () => {
  const minutes =
    currentDate.getMinutes() < 10 ?
    "0" + currentDate.getMinutes() :
    currentDate.getMinutes();

  currentDay = currentDate.getDay()

  const elements = [{
      class: ".today__text--dayName",
      content: days[currentDay]
    },
    {
      class: ".today__text--hour",
      content: `${currentDate.getHours()}: ${minutes}`
    }
  ];

  handleDisplayContent(elements);
};

// SearchEngine
const handleSubmitCity = event => {
  event.preventDefault();

  handleUnCheckFavorites("all");
  document.querySelector("#favorite").checked = "";

  const city = document.querySelector("#searchForm__field--city").value;

  // apiUrl = `https://api.openweathermap.org/data/2.5/weather?q=${city.toLowerCase()}&appid=${apiKey}&units=metric`;

  // if (city.length > 0) {
  //   axios
  //     .get(apiUrl)
  //     .then(response => {
  //       currentCity.data = response.data;
  //       handleCurrentForcast(response);
  //     })
  //     .catch(error => {
  //       console.log("ERROR: value NOT in list", error.response);
  //       sentence = `Sorry, we do not know the weather for this city, try going to https://www.google.com/search?q=weather+${city}`;
  //       handleGreeting(sentence);
  //     });
  // }

  const apiUrl1 = `https://api.openweathermap.org/data/2.5/weather?q=${city.toLowerCase()}&appid=${apiKey}&units=metric`;

  axios
    .get(apiUrl1)
    .then(response => {
      currentCityName = response.data.name;
      lat = response.data.coord.lat;
      long = response.data.coord.lon;

      apiUrl = `https://api.openweathermap.org/data/2.5/onecall?lat=${lat}&lon=${long}&exclude=minute&appid=${apiKey}&units=metric`;
      axios
        .get(apiUrl)
        .then(response => {
          currentCity.data = response.data;
          handleCurrentForcast(response);
        })
        .catch(error => {
          console.log(error.response);
        });
    })
    .catch(error => {
      console.log(error.response);
    });
};

const handleTestValue = value => {
  if (weather[value] !== undefined) {
    return true;
  } else {
    return false;
  }
};

const handleGreeting = greeting => {
  alert(greeting);
};

const handleGetValue = value => {
  return weather[value];
};

// Denoting temperature

const handleCheckCelsius = event => {
  const tempCurrentCity = currentCity;

  currentCity.data.current.temp = handleFahrenheitToCelsius(tempCurrentCity.data.current.temp);

  currentCity.data.hourly.map((item, i) => {
    item.temp = handleFahrenheitToCelsius(item.temp)
  });

  handleDisplayCurrentWeatherLocation();
  handleDisplayHourlyWeatherLocation();
};

const handleCheckFahrenheit = event => {
  const tempCurrentCity = currentCity;

  console.log(tempCurrentCity, tempCurrentCity.data.current.temp);
  currentCity.data.current.temp = handleCelsiusToFahrenheit(tempCurrentCity.data.current.temp);

  currentCity.data.hourly.map((item, i) => {
    item.temp = handleCelsiusToFahrenheit(item.temp)
  });

  handleDisplayCurrentWeatherLocation();
  handleDisplayHourlyWeatherLocation();
};

// favorites
const handleClickFavoriteItem = event => {
  handleUnCheckFavorites(event.target.id);

  // currentCity = favorites[event.target.id];

  document.querySelector("#favorite").checked = "checked";

  const apiUrl1 = `https://api.openweathermap.org/data/2.5/weather?q=${event.target.id.toLowerCase()}&appid=${apiKey}&units=metric`;

  axios
    .get(apiUrl1)
    .then(response => {
      currentCity.name = response.data.name;

      lat = response.data.coord.lat;
      long = response.data.coord.lon;

      apiUrl = `https://api.openweathermap.org/data/2.5/onecall?lat=${lat}&lon=${long}&exclude=minute&appid=${apiKey}&units=metric`;
      axios
        .get(apiUrl)
        .then(response => {
          currentCity.data = response.data;
          handleDisplayCurrentWeatherLocation();
        })
        .catch(error => {
          console.log(error.response);
        });
    })
    .catch(error => {
      console.log(error.response);
    });
};

const handleUnCheckFavorites = value => {
  document.querySelectorAll(".favorites__field").forEach(element => {
    if (element.id !== value || value === "all") {
      element.checked = "";
    }
  });
  document.querySelector("#fahrenheit").checked = "";
  document.querySelector("#celcius").checked = 'checked';
};

const handleClickFavorite = event => {
  if (event.target.checked) {
    handleAddFavorite();
  } else {
    handleDeleteFavorite();
  }
};

const handleAddFavorite = event => {
  favorites[currentCity.name.toLowerCase()] = currentCity;

  handleDisplayFavorites();
};

const handleDeleteFavorite = () => {
  delete favorites[currentCity.name.toLocaleLowerCase()];

  handleDisplayFavorites();
};

const handleDisplayFavorites = () => {
  const list = document.querySelector("#favoritesList");

  list.innerHTML = "";

  for (const [key, value] of Object.entries(favorites)) {
    const li = document.createElement("li");

    li.innerHTML = `
      <input class='favorites__field favorites__field--hide' type='checkbox' id='${value.name.toLowerCase()}' />
      <label class='favorites__text' for='${value.name.toLowerCase()}'>${
      value.name
    }</label>`;

    li.classList.add("favorites__item");

    list.appendChild(li);

    document
      .querySelectorAll(".favorites__field")
      .forEach(element =>
        element.addEventListener("click", handleClickFavoriteItem)
      );
  }
};

// Weather API

const handleGetWeatherCurrentPosition = () => {
  // apiUrl = `https://api.openweathermap.org/data/2.5/onecall?lat=${lat}&lon=${long}&appid=${apiKey}&units=metric`;
  const apiUrl1 = `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${long}&appid=${apiKey}&units=metric`;
  apiUrl = `https://api.openweathermap.org/data/2.5/onecall?lat=${lat}&lon=${long}&exclude=minute&appid=${apiKey}&units=metric`;

  if (lat && long) {
    axios
      .get(apiUrl1)
      .then(response => {
        currentCityName = response.data.name;
        axios
          .get(apiUrl)
          .then(response => {
            currentCity.data = response.data;
            handleCurrentForcast(response);
          })
          .catch(error => {
            console.log(error.response);
          });
      })
      .catch(error => {
        console.log(error.response);
      });
  }
};

// Geolocation API
const handlePosition = response => {
  currentPosition = response;
  lat = currentPosition.coords.latitude;
  long = currentPosition.coords.longitude;

  handleGetWeatherCurrentPosition();
  // axios
  //   .get(
  //     `https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${long}&localityLanguage=en`
  //   )
  //   .then(response => {
  //     currentCity.name = response.data.city;
  //     handleGetWeatherCurrentPosition();
  //   })
  //   .catch(error => {
  //     console.log(error.response);
  //   });
};

function handleCurrentForcast(response) {
  console.log(response)
  currentCity.name = currentCityName;

  handleDisplayCurrentWeatherLocation();
  handleDisplayHourlyWeatherLocation();
  handleDisplayDailyWeatherLocation();
}

const init = () => {
  handleGetCurrentLocation();

  document
    .querySelectorAll("#button--currentLocation")
    .forEach(element =>
      element.addEventListener("click", handleGetCurrentLocation)
    );

  document
    .querySelector("#searchForm--city")
    .addEventListener("submit", handleSubmitCity);

  document
    .querySelector("#celcius")
    .addEventListener("change", handleCheckCelsius);

  document
    .querySelector("#fahrenheit")
    .addEventListener("change", handleCheckFahrenheit);

  document
    .querySelectorAll(".favorites__field")
    .forEach(element =>
      element.addEventListener("click", handleClickFavoriteItem)
    );

  document
    .querySelector("#favorite")
    .addEventListener("change", handleClickFavorite);

  handleChangeDate();

  handleDisplayFavorites();
};

init();